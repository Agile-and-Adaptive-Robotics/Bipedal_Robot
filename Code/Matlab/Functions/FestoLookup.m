clear;
clc;
close all;

%% Create Festo force lookup tables based on their datasheets
Y = linspace(0,600,7);                      %Pressure for interpolation
z20max = 1500;                              %Max force in 20mm BPA
z40max = 6000;                              %Max force in 40mm BPA
Pmax = 600;                                 %Max pressure in 20 & 40 mm BPAs
Emax = 0.25;                                %Max contraction in 20 and 40 mm BPAs

%% 40mm dia BPA
X1 = linspace(-0.05,0.25,31);   %Contraction percent for interpolation
FestoLookup40 = zeros(size(Y,2),size(X1,2));
x40_1 = [-0.05 -0.04 -0.03, -.02   -.01  0 0.25]';
z40_1 = [2141   1325 789.6   427.4 176.6 0 -383]';                  %0 kPa force, N
x40_2 = [-0.05  -.04  -.03  -0.02 -0.01     0   0.05 0.12 0.18 0.25]';
z40_2 = [3317   2482  1922   1532  1250  1040   500  193    22 -155]';    %100 kPa force, N
x40_3 = [-0.05 -.03 -.01    0 0.02  0.04 0.08 0.12 0.20 0.25]';
z40_3 = [4489  3053 2321 2078 1720  1463 1093  809  340   76]';         %200 kPa force, N
x40_4 = [-.05 -.03 -.02 .005 0.03 0.06 0.16, .25]';
z40_4 = [5657 4179 3733 3000 2513 2084 1000, 311]';         %300 kPa force, N
x40_5 = [-0.05 -.041 -.01 .005 0.05 0.11 0.20 0.25]';
z40_5 = [ 6817  6000 4454 4009 3074 2178 1091 551]';     %400 kPa force, N
x40_6 = [-.05 -.022 -.01 .008 0.04 0.09 0.15 0.23 .25]';
z40_6 = [7967  6006 5513 4933 4142 3173 2200 1062 800]';    %500 kPa force, N
x40_7 = [-.05 -.02 .006 0.02 0.04 .075 0.12 .175 0.25]';
z40_7 = [9105 7000 6000 5568 5031 4214 3293 2286 1051]';     %600 kPa force, N


x40 = [x40_1; x40_2; x40_3; x40_4; x40_5; x40_6; x40_7];
y40 = [0*ones(length(x40_1),1); 
       100*ones(length(x40_2),1); 
       200*ones(length(x40_3),1);
       300*ones(length(x40_4),1);
       400*ones(length(x40_5),1);
       500*ones(length(x40_6),1);
       600*ones(length(x40_7),1)];
z40 = [z40_1;
       z40_2;
       z40_3;
       z40_4;
       z40_5;
       z40_6;
       z40_7];

x40norm = x40/Emax;
y40norm = y40/Pmax;
z40norm = z40/z40max;

%% 20 mm BPA
X2 = linspace(-0.04,0.25,30);   %Strain range for interpolation
FestoLookup20 = zeros(size(Y,2),size(X2,2));
x20_1 = [-.04 -.03 -.02 -.01 0 0.03 .125 .25]';
z20_1 = [ 684  416  229   96 0 -160 -270 -287]';                   %0 kPa force, N
x20_2 = [-.04 -.03 -.02 -.01 0   0.02 0.06 0.17 .25]';
z20_2 = [ 940  672  486  352 253 123    -8 -147 -218]';       %100 kPa force, N
x20_3 = [-.04 -.02 -.01 0.01 .05 .12 .155 .25]';
z20_3 = [1194  743  608  429 240 112 8.7  -150]';            %200 kPa force, N
x20_4 = [-.04 -.03 -.01 .01 .04 .12 .21 .25]';
z20_4 = [1451 1187  864 678 507 241  13 -84]';          %300 kPa force, N
x20_5 = [-.04 -.02    0 .01 .04 .09 .16 .24 .25]';
z20_5 = [1707 1257 1012 926 737 518 271  13 -19]';     %400 kPa force, N
x20_6 = [-.04 -.02    0 0.01 .04 .08 .13 .195 .22 .25]';
z20_6 = [1963 1514 1264 1173 966 756 531  262 162  45]';    %500 kPa force, N
x20_7 = [-.04 0.00 .035 .065 .11 .25]';
z20_7 = [2219 1515 1228 1040 791 107]';                 %600 kPa force, N

x20 = [x20_1; x20_2; x20_3; x20_4; x20_5; x20_6; x20_7];
y20 = [0*ones(length(x20_1),1); 
       100*ones(length(x20_2),1); 
       200*ones(length(x20_3),1);
       300*ones(length(x20_4),1);
       400*ones(length(x20_5),1);
       500*ones(length(x20_6),1);
       600*ones(length(x20_7),1)];
z20 = [z20_1; z20_2; z20_3; z20_4; z20_5; z20_6; z20_7];

x20norm = x20/Emax;
y20norm = y20/Pmax;
z20norm = z20/z20max;
%% From Curve Fit app generate code
% For 10mm Data:
RelativeStrain = linspace(0,1,30);
P = linspace(0,620,19);
load ForceStrainForFit.mat z
%% Initialization.

% Initialize arrays to store fits and goodness-of-fit.
fitresult = cell( 9, 1 );
gof = struct( 'sse', cell( 9, 1 ), ...
    'rsquare', [], 'dfe', [], 'adjrsquare', [], 'rmse', [] );

%% Fit: 'Exponential 40'.
[xData, yData, zData] = prepareSurfaceData( x40, y40, z40 );

% Set up fittype and options.
ft = fittype( 'a0+exp(-a1.*x+a2)+y.*exp(-a3.*x+a4)+a5*y', 'independent', {'x', 'y'}, 'dependent', 'z' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.StartPoint = [0.655740699156587 0.0357116785741896 0.849129305868777 1.2 0.6787 0.757740130578333];

% Fit model to data.
[fitresult{1}, gof(1)] = fit( [xData, yData], zData, ft, opts );

% Create a figure for the plots.
figure( 'Name', 'Exponential 40' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{1}, [xData, yData], zData );
legend( h, 'Exponential 40', 'z40 vs. x40, y40', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40', 'Interpreter', 'none' );
ylabel( 'y40', 'Interpreter', 'none' );
zlabel( 'z40', 'Interpreter', 'none' );
grid on

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{1}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Exponential 40 - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40', 'Interpreter', 'none' );
ylabel( 'y40', 'Interpreter', 'none' );
zlabel( 'z40', 'Interpreter', 'none' );
grid on

%% Fit: 'Exponential 20'.
[xData, yData, zData] = prepareSurfaceData( x20, y20, z20 );

% Set up fittype and options.
ft = fittype( 'a0+exp(-a1*x+a2)+y.*exp(-(a3*x).^2+a4)+a5*y', 'independent', {'x', 'y'}, 'dependent', 'z' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.MaxFunEvals = 6000;
opts.MaxIter = 4000;
opts.StartPoint = [0.530797553008973 0.779167230102011 0.934010684229183 0.12990620847373 0.5688 -0.4694];

% Fit model to data.
[fitresult{2}, gof(2)] = fit( [xData, yData], zData, ft, opts );

% Create a figure for the plots.
figure( 'Name', 'Exponential 20' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{2}, [xData, yData], zData );
legend( h, 'Exponential 20', 'z20 vs. x20, y20', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x20', 'Interpreter', 'none' );
ylabel( 'y20', 'Interpreter', 'none' );
zlabel( 'z20', 'Interpreter', 'none' );
grid on

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{2}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Exponential 20 - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x20', 'Interpreter', 'none' );
ylabel( 'y20', 'Interpreter', 'none' );
zlabel( 'z20', 'Interpreter', 'none' );
grid on

%% Fit: 'Polynomial 20'.
[xData, yData, zData] = prepareSurfaceData( x20, y20, z20 );

% Set up fittype and options.
ft = fittype( 'poly51' );

% Fit model to data.
[fitresult{3}, gof(3)] = fit( [xData, yData], zData, ft, 'Normalize', 'on' );

% Create a figure for the plots.
figure( 'Name', 'Polynomial 20' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{3}, [xData, yData], zData, 'Style', 'PredObs' );
legend( h, 'Polynomial 20', 'z20 vs. x20, y20', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x20', 'Interpreter', 'none' );
ylabel( 'y20', 'Interpreter', 'none' );
zlabel( 'z20', 'Interpreter', 'none' );
grid on
view( -31.2, 23.9 );

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{3}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Polynomial 20 - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x20', 'Interpreter', 'none' );
ylabel( 'y20', 'Interpreter', 'none' );
zlabel( 'z20', 'Interpreter', 'none' );
grid on
view( -31.2, 23.9 );

%% Fit: 'Polynomial 40'.
[xData, yData, zData] = prepareSurfaceData( x40, y40, z40 );

% Set up fittype and options.
ft = fittype( 'poly51' );

% Fit model to data.
[fitresult{4}, gof(4)] = fit( [xData, yData], zData, ft, 'Normalize', 'on' );

% Create a figure for the plots.
figure( 'Name', 'Polynomial 40' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{4}, [xData, yData], zData );
legend( h, 'Polynomial 40', 'z40 vs. x40, y40', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40', 'Interpreter', 'none' );
ylabel( 'y40', 'Interpreter', 'none' );
zlabel( 'z40', 'Interpreter', 'none' );
grid on

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{4}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Polynomial 40 - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40', 'Interpreter', 'none' );
ylabel( 'y40', 'Interpreter', 'none' );
zlabel( 'z40', 'Interpreter', 'none' );
grid on

%% Fit: 'Exponential 10'.
[xData, yData, zData] = prepareSurfaceData( P, RelativeStrain, z );

% Set up fittype and options.
ft = fittype( 'a0+exp(-a1*y+a2)+x.*exp(-(a3*y).^2+a4)+a5*x', 'independent', {'x', 'y'}, 'dependent', 'z' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.Lower = [-Inf 0 -Inf 0 -Inf -Inf];
opts.MaxFunEvals = 2500;
opts.MaxIter = 1000;
opts.Robust = 'LAR';
opts.StartPoint = [-139.9 6.307 5.166 0.9415 -0.2789 -0.08143];
opts.Upper = [0 Inf Inf Inf Inf Inf];

% Fit model to data.
[fitresult{5}, gof(5)] = fit( [xData, yData], zData, ft, opts );

% Create a figure for the plots.
figure( 'Name', 'Exponential 10' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{5}, [xData, yData], zData );
legend( h, 'Exponential 10', 'z vs. P, RelativeStrain', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'P', 'Interpreter', 'none' );
ylabel( 'RelativeStrain', 'Interpreter', 'none' );
zlabel( 'z', 'Interpreter', 'none' );
grid on

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{5}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Exponential 10 - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'P', 'Interpreter', 'none' );
ylabel( 'RelativeStrain', 'Interpreter', 'none' );
zlabel( 'z', 'Interpreter', 'none' );
grid on

%% Fit: 'Polynomial 10'.
[xData, yData, zData] = prepareSurfaceData( RelativeStrain, P, z );

% Set up fittype and options.
ft = fittype( 'poly51' );

% Fit model to data.
[fitresult{6}, gof(6)] = fit( [xData, yData], zData, ft, 'Normalize', 'on' );

% Plot fit with data.
figure( 'Name', 'Polynomial 10' );
h = plot( fitresult{6}, [xData, yData], zData );
legend( h, 'Polynomial 10', 'z vs. RelativeStrain, P', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'RelativeStrain', 'Interpreter', 'none' );
ylabel( 'P', 'Interpreter', 'none' );
zlabel( 'z', 'Interpreter', 'none' );
grid on

%% Fit: 'Exponential 20 normalized'.
[xData, yData, zData] = prepareSurfaceData( x20norm, y20norm, z20norm );

% Set up fittype and options.
ft = fittype( 'a0+exp(-a1*x+a2)+y.*exp(-a3*x.^2-a4)+a4*y', 'independent', {'x', 'y'}, 'dependent', 'z' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.Lower = [-Inf 0 -Inf 0 -Inf];
opts.MaxFunEvals = 6000;
opts.MaxIter = 4000;
opts.Robust = 'LAR';
opts.StartPoint = [-0.1881 7.965 -1.677 2.036 0.1518];
opts.Upper = [0 Inf Inf Inf Inf];

% Fit model to data.
[fitresult{7}, gof(7)] = fit( [xData, yData], zData, ft, opts );
f20 = fitresult{7}
gof20 = gof(7)

FestoLookup20(1,:) = f20(X2/Emax,0);
FestoLookup20(2,:) = f20(X2/Emax,100/Pmax);
FestoLookup20(3,:) = f20(X2/Emax,200/Pmax);
FestoLookup20(4,:) = f20(X2/Emax,300/Pmax);
FestoLookup20(5,:) = f20(X2/Emax,400/Pmax); 
FestoLookup20(6,:) = f20(X2/Emax,500/Pmax);
FestoLookup20(7,:) = f20(X2/Emax,600/Pmax);

% Plot fit with data.
figure20 = figure( 'Name', 'Exponential 20 normalized' );
h = plot( fitresult{7}, [xData, yData], zData);
% Create figure
set(figure20,'Tag','Print CFTOOL to Figure',...
    'Color',[0.941176470588235 0.941176470588235 0.941176470588235],...
    'OuterPosition',[2423.4 215.4 1387.2 575.2]);

% Create axes
axes1 = gca;
set(axes1,'Tag','sftool surface axes','Parent',figure20);
hold(axes1,'on');

% Create zlabel
zlabel('\bf F^*','FontWeight','bold','FontName','Arial');

% Create ylabel
ylabel('\bf P^*','FontWeight','bold','FontName','Arial');

% Create xlabel
xlabel('\bf \epsilon^*','FontWeight','bold','FontName','Arial');

% Create title
title('\bf Normalized force for $\phi 20$ mm BPAs','Interpreter','latex');

% Uncomment the following line to preserve the X-limits of the axes
% xlim(axes1,[-0.218 1.058]);
% Uncomment the following line to preserve the Y-limits of the axes
% ylim(axes1,[-0.05 1.05]);
% Uncomment the following line to preserve the Z-limits of the axes
% zlim(axes1,[-0.2749 1.5629]);
view(axes1,[-10.8244951493102 26.7888687019239]);
box(axes1,'on');
grid(axes1,'on');
hold(axes1,'off');
% Set the remaining axes properties
set(axes1,'CLim',[0.152 1.52],'ColorScale','log','Colormap',...
    [1 0 1;1 0.00392156862745098 0.996078431372549;1 0.00784313725490196 0.992156862745098;1 0.0117647058823529 0.988235294117647;1 0.0156862745098039 0.984313725490196;1 0.0196078431372549 0.980392156862745;1 0.0235294117647059 0.976470588235294;1 0.0274509803921569 0.972549019607843;1 0.0313725490196078 0.968627450980392;1 0.0352941176470588 0.964705882352941;1 0.0392156862745098 0.96078431372549;1 0.0431372549019608 0.956862745098039;1 0.0470588235294118 0.952941176470588;1 0.0509803921568627 0.949019607843137;1 0.0549019607843137 0.945098039215686;1 0.0588235294117647 0.941176470588235;1 0.0627450980392157 0.937254901960784;1 0.0666666666666667 0.933333333333333;1 0.0705882352941176 0.929411764705882;1 0.0745098039215686 0.925490196078431;1 0.0784313725490196 0.92156862745098;1 0.0823529411764706 0.917647058823529;1 0.0862745098039216 0.913725490196078;1 0.0901960784313725 0.909803921568627;1 0.0941176470588235 0.905882352941176;1 0.0980392156862745 0.901960784313726;1 0.101960784313725 0.898039215686275;1 0.105882352941176 0.894117647058824;1 0.109803921568627 0.890196078431372;1 0.113725490196078 0.886274509803922;1 0.117647058823529 0.882352941176471;1 0.12156862745098 0.87843137254902;1 0.125490196078431 0.874509803921569;1 0.129411764705882 0.870588235294118;1 0.133333333333333 0.866666666666667;1 0.137254901960784 0.862745098039216;1 0.141176470588235 0.858823529411765;1 0.145098039215686 0.854901960784314;1 0.149019607843137 0.850980392156863;1 0.152941176470588 0.847058823529412;1 0.156862745098039 0.843137254901961;1 0.16078431372549 0.83921568627451;1 0.164705882352941 0.835294117647059;1 0.168627450980392 0.831372549019608;1 0.172549019607843 0.827450980392157;1 0.176470588235294 0.823529411764706;1 0.180392156862745 0.819607843137255;1 0.184313725490196 0.815686274509804;1 0.188235294117647 0.811764705882353;1 0.192156862745098 0.807843137254902;1 0.196078431372549 0.803921568627451;1 0.2 0.8;1 0.203921568627451 0.796078431372549;1 0.207843137254902 0.792156862745098;1 0.211764705882353 0.788235294117647;1 0.215686274509804 0.784313725490196;1 0.219607843137255 0.780392156862745;1 0.223529411764706 0.776470588235294;1 0.227450980392157 0.772549019607843;1 0.231372549019608 0.768627450980392;1 0.235294117647059 0.764705882352941;1 0.23921568627451 0.76078431372549;1 0.243137254901961 0.756862745098039;1 0.247058823529412 0.752941176470588;1 0.250980392156863 0.749019607843137;1 0.254901960784314 0.745098039215686;1 0.258823529411765 0.741176470588235;1 0.262745098039216 0.737254901960784;1 0.266666666666667 0.733333333333333;1 0.270588235294118 0.729411764705882;1 0.274509803921569 0.725490196078431;1 0.27843137254902 0.72156862745098;1 0.282352941176471 0.717647058823529;1 0.286274509803922 0.713725490196078;1 0.290196078431373 0.709803921568627;1 0.294117647058824 0.705882352941176;1 0.298039215686275 0.701960784313725;1 0.301960784313725 0.698039215686274;1 0.305882352941176 0.694117647058824;1 0.309803921568627 0.690196078431373;1 0.313725490196078 0.686274509803922;1 0.317647058823529 0.682352941176471;1 0.32156862745098 0.67843137254902;1 0.325490196078431 0.674509803921569;1 0.329411764705882 0.670588235294118;1 0.333333333333333 0.666666666666667;1 0.337254901960784 0.662745098039216;1 0.341176470588235 0.658823529411765;1 0.345098039215686 0.654901960784314;1 0.349019607843137 0.650980392156863;1 0.352941176470588 0.647058823529412;1 0.356862745098039 0.643137254901961;1 0.36078431372549 0.63921568627451;1 0.364705882352941 0.635294117647059;1 0.368627450980392 0.631372549019608;1 0.372549019607843 0.627450980392157;1 0.376470588235294 0.623529411764706;1 0.380392156862745 0.619607843137255;1 0.384313725490196 0.615686274509804;1 0.388235294117647 0.611764705882353;1 0.392156862745098 0.607843137254902;1 0.396078431372549 0.603921568627451;1 0.4 0.6;1 0.403921568627451 0.596078431372549;1 0.407843137254902 0.592156862745098;1 0.411764705882353 0.588235294117647;1 0.415686274509804 0.584313725490196;1 0.419607843137255 0.580392156862745;1 0.423529411764706 0.576470588235294;1 0.427450980392157 0.572549019607843;1 0.431372549019608 0.568627450980392;1 0.435294117647059 0.564705882352941;1 0.43921568627451 0.56078431372549;1 0.443137254901961 0.556862745098039;1 0.447058823529412 0.552941176470588;1 0.450980392156863 0.549019607843137;1 0.454901960784314 0.545098039215686;1 0.458823529411765 0.541176470588235;1 0.462745098039216 0.537254901960784;1 0.466666666666667 0.533333333333333;1 0.470588235294118 0.529411764705882;1 0.474509803921569 0.525490196078431;1 0.47843137254902 0.52156862745098;1 0.482352941176471 0.517647058823529;1 0.486274509803922 0.513725490196078;1 0.490196078431373 0.509803921568627;1 0.494117647058824 0.505882352941176;1 0.498039215686275 0.501960784313725;1 0.501960784313725 0.498039215686275;1 0.505882352941176 0.494117647058824;1 0.509803921568627 0.490196078431373;1 0.513725490196078 0.486274509803922;1 0.517647058823529 0.482352941176471;1 0.52156862745098 0.47843137254902;1 0.525490196078431 0.474509803921569;1 0.529411764705882 0.470588235294118;1 0.533333333333333 0.466666666666667;1 0.537254901960784 0.462745098039216;1 0.541176470588235 0.458823529411765;1 0.545098039215686 0.454901960784314;1 0.549019607843137 0.450980392156863;1 0.552941176470588 0.447058823529412;1 0.556862745098039 0.443137254901961;1 0.56078431372549 0.43921568627451;1 0.564705882352941 0.435294117647059;1 0.568627450980392 0.431372549019608;1 0.572549019607843 0.427450980392157;1 0.576470588235294 0.423529411764706;1 0.580392156862745 0.419607843137255;1 0.584313725490196 0.415686274509804;1 0.588235294117647 0.411764705882353;1 0.592156862745098 0.407843137254902;1 0.596078431372549 0.403921568627451;1 0.6 0.4;1 0.603921568627451 0.396078431372549;1 0.607843137254902 0.392156862745098;1 0.611764705882353 0.388235294117647;1 0.615686274509804 0.384313725490196;1 0.619607843137255 0.380392156862745;1 0.623529411764706 0.376470588235294;1 0.627450980392157 0.372549019607843;1 0.631372549019608 0.368627450980392;1 0.635294117647059 0.364705882352941;1 0.63921568627451 0.36078431372549;1 0.643137254901961 0.356862745098039;1 0.647058823529412 0.352941176470588;1 0.650980392156863 0.349019607843137;1 0.654901960784314 0.345098039215686;1 0.658823529411765 0.341176470588235;1 0.662745098039216 0.337254901960784;1 0.666666666666667 0.333333333333333;1 0.670588235294118 0.329411764705882;1 0.674509803921569 0.325490196078431;1 0.67843137254902 0.32156862745098;1 0.682352941176471 0.317647058823529;1 0.686274509803922 0.313725490196078;1 0.690196078431373 0.309803921568627;1 0.694117647058824 0.305882352941176;1 0.698039215686274 0.301960784313726;1 0.701960784313725 0.298039215686275;1 0.705882352941177 0.294117647058823;1 0.709803921568627 0.290196078431373;1 0.713725490196078 0.286274509803922;1 0.717647058823529 0.282352941176471;1 0.72156862745098 0.27843137254902;1 0.725490196078431 0.274509803921569;1 0.729411764705882 0.270588235294118;1 0.733333333333333 0.266666666666667;1 0.737254901960784 0.262745098039216;1 0.741176470588235 0.258823529411765;1 0.745098039215686 0.254901960784314;1 0.749019607843137 0.250980392156863;1 0.752941176470588 0.247058823529412;1 0.756862745098039 0.243137254901961;1 0.76078431372549 0.23921568627451;1 0.764705882352941 0.235294117647059;1 0.768627450980392 0.231372549019608;1 0.772549019607843 0.227450980392157;1 0.776470588235294 0.223529411764706;1 0.780392156862745 0.219607843137255;1 0.784313725490196 0.215686274509804;1 0.788235294117647 0.211764705882353;1 0.792156862745098 0.207843137254902;1 0.796078431372549 0.203921568627451;1 0.8 0.2;1 0.803921568627451 0.196078431372549;1 0.807843137254902 0.192156862745098;1 0.811764705882353 0.188235294117647;1 0.815686274509804 0.184313725490196;1 0.819607843137255 0.180392156862745;1 0.823529411764706 0.176470588235294;1 0.827450980392157 0.172549019607843;1 0.831372549019608 0.168627450980392;1 0.835294117647059 0.164705882352941;1 0.83921568627451 0.16078431372549;1 0.843137254901961 0.156862745098039;1 0.847058823529412 0.152941176470588;1 0.850980392156863 0.149019607843137;1 0.854901960784314 0.145098039215686;1 0.858823529411765 0.141176470588235;1 0.862745098039216 0.137254901960784;1 0.866666666666667 0.133333333333333;1 0.870588235294118 0.129411764705882;1 0.874509803921569 0.125490196078431;1 0.87843137254902 0.12156862745098;1 0.882352941176471 0.117647058823529;1 0.886274509803922 0.113725490196078;1 0.890196078431372 0.109803921568628;1 0.894117647058824 0.105882352941176;1 0.898039215686275 0.101960784313725;1 0.901960784313726 0.0980392156862745;1 0.905882352941176 0.0941176470588235;1 0.909803921568627 0.0901960784313726;1 0.913725490196078 0.0862745098039216;1 0.917647058823529 0.0823529411764706;1 0.92156862745098 0.0784313725490197;1 0.925490196078431 0.0745098039215686;1 0.929411764705882 0.0705882352941176;1 0.933333333333333 0.0666666666666667;1 0.937254901960784 0.0627450980392157;1 0.941176470588235 0.0588235294117647;1 0.945098039215686 0.0549019607843138;1 0.949019607843137 0.0509803921568628;1 0.952941176470588 0.0470588235294118;1 0.956862745098039 0.0431372549019607;1 0.96078431372549 0.0392156862745098;1 0.964705882352941 0.0352941176470588;1 0.968627450980392 0.0313725490196078;1 0.972549019607843 0.0274509803921569;1 0.976470588235294 0.0235294117647059;1 0.980392156862745 0.0196078431372549;1 0.984313725490196 0.015686274509804;1 0.988235294117647 0.0117647058823529;1 0.992156862745098 0.00784313725490193;1 0.996078431372549 0.00392156862745097;1 1 0],...
    'FontName','Arial','FontSize',12,'FontWeight','bold','LineWidth',2);
% Create legend
legend1 = legend(axes1,'show');
set(legend1,...
    'Position',[0.595490003034231 0.728171334431631 0.119318183777216 0.0557502431802162],...
    'LineWidth',1.5,...
    'Interpreter','none',...
    'FontSize',10,...
    'EdgeColor',[0.15 0.15 0.15]);


%% Fit: 'Exponential 40 normalized'.
[xData, yData, zData] = prepareSurfaceData( x40norm, y40norm, z40norm );

% Set up fittype and options.
ft = fittype( 'a0+exp(-a1.*x+a2)+y.*exp(-a3.*x+a4)+a5*y', 'independent', {'x', 'y'}, 'dependent', 'z' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.Lower = [-Inf 0 -Inf 0 -Inf -Inf];
opts.MaxFunEvals = 6000;
opts.MaxIter = 4000;
opts.Robust = 'LAR';
opts.StartPoint = [-0.06974 8.547 -2.268 0.2854 1.148 -2.128];
opts.Upper = [0 Inf Inf Inf Inf Inf];

% Fit model to data.
[fitresult{8}, gof(8)] = fit( [xData, yData], zData, ft, opts );
f40 = fitresult{8}
gof40 = gof(8)

FestoLookup40(1,:) = f40(X1/Emax,0);
FestoLookup40(2,:) = f40(X1/Emax,100/Pmax);
FestoLookup40(3,:) = f40(X1/Emax,200/Pmax);
FestoLookup40(4,:) = f40(X1/Emax,300/Pmax);
FestoLookup40(5,:) = f40(X1/Emax,400/Pmax);
FestoLookup40(6,:) = f40(X1/Emax,500/Pmax);
FestoLookup40(7,:) = f40(X1/Emax,600/Pmax);

% Plot fit with data.
% Plot fit with data.
figure40 = figure( 'Name', 'Exponential 20 normalized' );
h40 = plot( fitresult{8}, [xData, yData], zData);
% Create figure
set(figure40,'Tag','Print CFTOOL to Figure',...
    'Color',[0.941176470588235 0.941176470588235 0.941176470588235],...
    'OuterPosition',[2423.4 215.4 1387.2 575.2]);

% Create axes
axes1 = gca;
set(axes1,'Tag','sftool surface axes','Parent',figure40);
hold(axes1,'on');

% Create zlabel
zlabel('\bf F^*','FontWeight','bold','FontName','Arial');

% Create ylabel
ylabel('\bf P^*','FontWeight','bold','FontName','Arial');

% Create xlabel
xlabel('\bf \epsilon^*','FontWeight','bold','FontName','Arial');

% Create title
title('\bf Normalized force for $\phi 40$ mm BPAs','Interpreter','latex');

% Uncomment the following line to preserve the X-limits of the axes
% xlim(axes1,[-0.218 1.058]);
% Uncomment the following line to preserve the Y-limits of the axes
% ylim(axes1,[-0.05 1.05]);
% Uncomment the following line to preserve the Z-limits of the axes
% zlim(axes1,[-0.2749 1.5629]);
view(axes1,[-10.8244951493102 26.7888687019239]);
box(axes1,'on');
grid(axes1,'on');
hold(axes1,'off');
% Set the remaining axes properties
set(axes1,'CLim',[0.152 1.52],'ColorScale','log','Colormap',...
    [1 0 1;1 0.00392156862745098 0.996078431372549;1 0.00784313725490196 0.992156862745098;1 0.0117647058823529 0.988235294117647;1 0.0156862745098039 0.984313725490196;1 0.0196078431372549 0.980392156862745;1 0.0235294117647059 0.976470588235294;1 0.0274509803921569 0.972549019607843;1 0.0313725490196078 0.968627450980392;1 0.0352941176470588 0.964705882352941;1 0.0392156862745098 0.96078431372549;1 0.0431372549019608 0.956862745098039;1 0.0470588235294118 0.952941176470588;1 0.0509803921568627 0.949019607843137;1 0.0549019607843137 0.945098039215686;1 0.0588235294117647 0.941176470588235;1 0.0627450980392157 0.937254901960784;1 0.0666666666666667 0.933333333333333;1 0.0705882352941176 0.929411764705882;1 0.0745098039215686 0.925490196078431;1 0.0784313725490196 0.92156862745098;1 0.0823529411764706 0.917647058823529;1 0.0862745098039216 0.913725490196078;1 0.0901960784313725 0.909803921568627;1 0.0941176470588235 0.905882352941176;1 0.0980392156862745 0.901960784313726;1 0.101960784313725 0.898039215686275;1 0.105882352941176 0.894117647058824;1 0.109803921568627 0.890196078431372;1 0.113725490196078 0.886274509803922;1 0.117647058823529 0.882352941176471;1 0.12156862745098 0.87843137254902;1 0.125490196078431 0.874509803921569;1 0.129411764705882 0.870588235294118;1 0.133333333333333 0.866666666666667;1 0.137254901960784 0.862745098039216;1 0.141176470588235 0.858823529411765;1 0.145098039215686 0.854901960784314;1 0.149019607843137 0.850980392156863;1 0.152941176470588 0.847058823529412;1 0.156862745098039 0.843137254901961;1 0.16078431372549 0.83921568627451;1 0.164705882352941 0.835294117647059;1 0.168627450980392 0.831372549019608;1 0.172549019607843 0.827450980392157;1 0.176470588235294 0.823529411764706;1 0.180392156862745 0.819607843137255;1 0.184313725490196 0.815686274509804;1 0.188235294117647 0.811764705882353;1 0.192156862745098 0.807843137254902;1 0.196078431372549 0.803921568627451;1 0.2 0.8;1 0.203921568627451 0.796078431372549;1 0.207843137254902 0.792156862745098;1 0.211764705882353 0.788235294117647;1 0.215686274509804 0.784313725490196;1 0.219607843137255 0.780392156862745;1 0.223529411764706 0.776470588235294;1 0.227450980392157 0.772549019607843;1 0.231372549019608 0.768627450980392;1 0.235294117647059 0.764705882352941;1 0.23921568627451 0.76078431372549;1 0.243137254901961 0.756862745098039;1 0.247058823529412 0.752941176470588;1 0.250980392156863 0.749019607843137;1 0.254901960784314 0.745098039215686;1 0.258823529411765 0.741176470588235;1 0.262745098039216 0.737254901960784;1 0.266666666666667 0.733333333333333;1 0.270588235294118 0.729411764705882;1 0.274509803921569 0.725490196078431;1 0.27843137254902 0.72156862745098;1 0.282352941176471 0.717647058823529;1 0.286274509803922 0.713725490196078;1 0.290196078431373 0.709803921568627;1 0.294117647058824 0.705882352941176;1 0.298039215686275 0.701960784313725;1 0.301960784313725 0.698039215686274;1 0.305882352941176 0.694117647058824;1 0.309803921568627 0.690196078431373;1 0.313725490196078 0.686274509803922;1 0.317647058823529 0.682352941176471;1 0.32156862745098 0.67843137254902;1 0.325490196078431 0.674509803921569;1 0.329411764705882 0.670588235294118;1 0.333333333333333 0.666666666666667;1 0.337254901960784 0.662745098039216;1 0.341176470588235 0.658823529411765;1 0.345098039215686 0.654901960784314;1 0.349019607843137 0.650980392156863;1 0.352941176470588 0.647058823529412;1 0.356862745098039 0.643137254901961;1 0.36078431372549 0.63921568627451;1 0.364705882352941 0.635294117647059;1 0.368627450980392 0.631372549019608;1 0.372549019607843 0.627450980392157;1 0.376470588235294 0.623529411764706;1 0.380392156862745 0.619607843137255;1 0.384313725490196 0.615686274509804;1 0.388235294117647 0.611764705882353;1 0.392156862745098 0.607843137254902;1 0.396078431372549 0.603921568627451;1 0.4 0.6;1 0.403921568627451 0.596078431372549;1 0.407843137254902 0.592156862745098;1 0.411764705882353 0.588235294117647;1 0.415686274509804 0.584313725490196;1 0.419607843137255 0.580392156862745;1 0.423529411764706 0.576470588235294;1 0.427450980392157 0.572549019607843;1 0.431372549019608 0.568627450980392;1 0.435294117647059 0.564705882352941;1 0.43921568627451 0.56078431372549;1 0.443137254901961 0.556862745098039;1 0.447058823529412 0.552941176470588;1 0.450980392156863 0.549019607843137;1 0.454901960784314 0.545098039215686;1 0.458823529411765 0.541176470588235;1 0.462745098039216 0.537254901960784;1 0.466666666666667 0.533333333333333;1 0.470588235294118 0.529411764705882;1 0.474509803921569 0.525490196078431;1 0.47843137254902 0.52156862745098;1 0.482352941176471 0.517647058823529;1 0.486274509803922 0.513725490196078;1 0.490196078431373 0.509803921568627;1 0.494117647058824 0.505882352941176;1 0.498039215686275 0.501960784313725;1 0.501960784313725 0.498039215686275;1 0.505882352941176 0.494117647058824;1 0.509803921568627 0.490196078431373;1 0.513725490196078 0.486274509803922;1 0.517647058823529 0.482352941176471;1 0.52156862745098 0.47843137254902;1 0.525490196078431 0.474509803921569;1 0.529411764705882 0.470588235294118;1 0.533333333333333 0.466666666666667;1 0.537254901960784 0.462745098039216;1 0.541176470588235 0.458823529411765;1 0.545098039215686 0.454901960784314;1 0.549019607843137 0.450980392156863;1 0.552941176470588 0.447058823529412;1 0.556862745098039 0.443137254901961;1 0.56078431372549 0.43921568627451;1 0.564705882352941 0.435294117647059;1 0.568627450980392 0.431372549019608;1 0.572549019607843 0.427450980392157;1 0.576470588235294 0.423529411764706;1 0.580392156862745 0.419607843137255;1 0.584313725490196 0.415686274509804;1 0.588235294117647 0.411764705882353;1 0.592156862745098 0.407843137254902;1 0.596078431372549 0.403921568627451;1 0.6 0.4;1 0.603921568627451 0.396078431372549;1 0.607843137254902 0.392156862745098;1 0.611764705882353 0.388235294117647;1 0.615686274509804 0.384313725490196;1 0.619607843137255 0.380392156862745;1 0.623529411764706 0.376470588235294;1 0.627450980392157 0.372549019607843;1 0.631372549019608 0.368627450980392;1 0.635294117647059 0.364705882352941;1 0.63921568627451 0.36078431372549;1 0.643137254901961 0.356862745098039;1 0.647058823529412 0.352941176470588;1 0.650980392156863 0.349019607843137;1 0.654901960784314 0.345098039215686;1 0.658823529411765 0.341176470588235;1 0.662745098039216 0.337254901960784;1 0.666666666666667 0.333333333333333;1 0.670588235294118 0.329411764705882;1 0.674509803921569 0.325490196078431;1 0.67843137254902 0.32156862745098;1 0.682352941176471 0.317647058823529;1 0.686274509803922 0.313725490196078;1 0.690196078431373 0.309803921568627;1 0.694117647058824 0.305882352941176;1 0.698039215686274 0.301960784313726;1 0.701960784313725 0.298039215686275;1 0.705882352941177 0.294117647058823;1 0.709803921568627 0.290196078431373;1 0.713725490196078 0.286274509803922;1 0.717647058823529 0.282352941176471;1 0.72156862745098 0.27843137254902;1 0.725490196078431 0.274509803921569;1 0.729411764705882 0.270588235294118;1 0.733333333333333 0.266666666666667;1 0.737254901960784 0.262745098039216;1 0.741176470588235 0.258823529411765;1 0.745098039215686 0.254901960784314;1 0.749019607843137 0.250980392156863;1 0.752941176470588 0.247058823529412;1 0.756862745098039 0.243137254901961;1 0.76078431372549 0.23921568627451;1 0.764705882352941 0.235294117647059;1 0.768627450980392 0.231372549019608;1 0.772549019607843 0.227450980392157;1 0.776470588235294 0.223529411764706;1 0.780392156862745 0.219607843137255;1 0.784313725490196 0.215686274509804;1 0.788235294117647 0.211764705882353;1 0.792156862745098 0.207843137254902;1 0.796078431372549 0.203921568627451;1 0.8 0.2;1 0.803921568627451 0.196078431372549;1 0.807843137254902 0.192156862745098;1 0.811764705882353 0.188235294117647;1 0.815686274509804 0.184313725490196;1 0.819607843137255 0.180392156862745;1 0.823529411764706 0.176470588235294;1 0.827450980392157 0.172549019607843;1 0.831372549019608 0.168627450980392;1 0.835294117647059 0.164705882352941;1 0.83921568627451 0.16078431372549;1 0.843137254901961 0.156862745098039;1 0.847058823529412 0.152941176470588;1 0.850980392156863 0.149019607843137;1 0.854901960784314 0.145098039215686;1 0.858823529411765 0.141176470588235;1 0.862745098039216 0.137254901960784;1 0.866666666666667 0.133333333333333;1 0.870588235294118 0.129411764705882;1 0.874509803921569 0.125490196078431;1 0.87843137254902 0.12156862745098;1 0.882352941176471 0.117647058823529;1 0.886274509803922 0.113725490196078;1 0.890196078431372 0.109803921568628;1 0.894117647058824 0.105882352941176;1 0.898039215686275 0.101960784313725;1 0.901960784313726 0.0980392156862745;1 0.905882352941176 0.0941176470588235;1 0.909803921568627 0.0901960784313726;1 0.913725490196078 0.0862745098039216;1 0.917647058823529 0.0823529411764706;1 0.92156862745098 0.0784313725490197;1 0.925490196078431 0.0745098039215686;1 0.929411764705882 0.0705882352941176;1 0.933333333333333 0.0666666666666667;1 0.937254901960784 0.0627450980392157;1 0.941176470588235 0.0588235294117647;1 0.945098039215686 0.0549019607843138;1 0.949019607843137 0.0509803921568628;1 0.952941176470588 0.0470588235294118;1 0.956862745098039 0.0431372549019607;1 0.96078431372549 0.0392156862745098;1 0.964705882352941 0.0352941176470588;1 0.968627450980392 0.0313725490196078;1 0.972549019607843 0.0274509803921569;1 0.976470588235294 0.0235294117647059;1 0.980392156862745 0.0196078431372549;1 0.984313725490196 0.015686274509804;1 0.988235294117647 0.0117647058823529;1 0.992156862745098 0.00784313725490193;1 0.996078431372549 0.00392156862745097;1 1 0],...
    'FontName','Arial','FontSize',12,'FontWeight','bold','LineWidth',2);
% Create legend
legend1 = legend(axes1,'show');
set(legend1,...
    'Position',[0.595490003034231 0.728171334431631 0.119318183777216 0.0557502431802162],...
    'LineWidth',1.5,...
    'Interpreter','none',...
    'FontSize',10,...
    'EdgeColor',[0.15 0.15 0.15]);

%% Fit: 'Polynomial 40 normalized'.
[xData, yData, zData] = prepareSurfaceData( x40norm, y40norm, z40norm );

% Set up fittype and options.
ft = fittype( 'poly51' );

% Fit model to data.
[fitresult{9}, gof(9)] = fit( [xData, yData], zData, ft, 'Normalize', 'on' );

% Create a figure for the plots.
figure( 'Name', 'Polynomial 40 normalized' );

% Plot fit with data.
subplot( 2, 1, 1 );
h = plot( fitresult{9}, [xData, yData], zData );
legend( h, 'Polynomial 40 normalized', 'z40norm vs. x40norm, y40norm', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40norm', 'Interpreter', 'none' );
ylabel( 'y40norm', 'Interpreter', 'none' );
zlabel( 'z40norm', 'Interpreter', 'none' );
grid on
view( -10.4, 21.9 );

% Plot residuals.
subplot( 2, 1, 2 );
h = plot( fitresult{9}, [xData, yData], zData, 'Style', 'Residual' );
legend( h, 'Polynomial 40 normalized - residuals', 'Location', 'NorthEast', 'Interpreter', 'none' );
% Label axes
xlabel( 'x40norm', 'Interpreter', 'none' );
ylabel( 'y40norm', 'Interpreter', 'none' );
zlabel( 'z40norm', 'Interpreter', 'none' );
grid on
view( -10.4, 21.9 );

%% Save it
save FestoLookup.mat f40 f20

%% Plot it
figure
plot(f40, [x40norm, y40norm],z40norm)
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Pressure, $kPA$','interpreter','latex'),zlabel('\bf Force, $N$','interpreter','latex')
title('\bf 40 $mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')

figure
plot(f20, [x20norm, y20norm],z20norm)
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Pressure, $kPA$','interpreter','latex'),zlabel('\bf Force, $N$','interpreter','latex')
title('\bf 40 $mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')

figure
surf(X1,Y,FestoLookup40*z40max)
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Pressure, $kPA$','interpreter','latex'),zlabel('\bf Force, $N$','interpreter','latex')
title('40 $mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')

figure
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Force, $N$','interpreter','latex')
title('\bf 40 $mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')
hold on
plot(X1,FestoLookup40(7,:)*z40max,'DisplayName','600 kPa, model')
plot(x40_7,z40_7,'o','DisplayName','600 kPa,  Festo')
plot(X1,FestoLookup40(6,:)*z40max,'DisplayName','500 kPa, model')
plot(x40_6,z40_6,'o','DisplayName','500 kPa,  Festo')
plot(X1,FestoLookup40(5,:)*z40max,'DisplayName','400 kPa, model')
plot(x40_5,z40_5,'o','DisplayName','400 kPa,  Festo')
plot(X1,FestoLookup40(4,:)*z40max,'DisplayName','300 kPa, model')
plot(x40_4,z40_4,'o','DisplayName','300 kPa,  Festo')
plot(X1,FestoLookup40(3,:)*z40max,'DisplayName','200 kPa, model')
plot(x40_3,z40_3,'o','DisplayName','200 kPa,  Festo')
plot(X1,FestoLookup40(2,:)*z40max,'DisplayName','100 kPa, model')
plot(x40_2,z40_2,'o','DisplayName','100 kPa,  Festo')
plot(X1,FestoLookup40(1,:)*z40max,'DisplayName','    0 kPa, model')
plot(x40_1,z40_1,'o','DisplayName','    0 kPa,  Festo')
lgd40 = legend;
title(lgd40,'\bf Pressure')
hold off

figure
surf(X2,Y,FestoLookup20*z20max)
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Pressure, kPA','interpreter','latex'),zlabel('\bf Force, N','interpreter','latex')
title('\bf 20 $ mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')

figure
xlabel('\bf Contraction','interpreter','latex'),ylabel('\bf Force, $N$','interpreter','latex')
title('\bf 20 $mm$ BPA Force-Pressure-Contraction relationship','interpreter','latex')
hold on
plot(X2,FestoLookup20(7,:)*z20max,'DisplayName','600 kPa, model')
plot(x20_7,z20_7,'o','DisplayName','600 kPa,  Festo')
plot(X2,FestoLookup20(6,:)*z20max,'DisplayName','500 kPa, model')
plot(x20_6,z20_6,'o','DisplayName','500 kPa,  Festo')
plot(X2,FestoLookup20(5,:)*z20max,'DisplayName','400 kPa, model')
plot(x20_5,z20_5,'o','DisplayName','400 kPa,  Festo')
plot(X2,FestoLookup20(4,:)*z20max,'DisplayName','300 kPa, model')
plot(x20_4,z20_4,'o','DisplayName','300 kPa,  Festo')
plot(X2,FestoLookup20(3,:)*z20max,'DisplayName','200 kPa, model')
plot(x20_3,z20_3,'o','DisplayName','200 kPa,  Festo')
plot(X2,FestoLookup20(2,:)*z20max,'DisplayName','100 kPa, model')
plot(x20_2,z20_2,'o','DisplayName','100 kPa,  Festo')
plot(X2,FestoLookup20(1,:)*z20max,'DisplayName','    0 kPa, model')
plot(x20_1,z20_1,'o','DisplayName','    0 kPa,  Festo')
lgd20 = legend;
title(lgd20,'\bf Pressure')
hold off
